<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>경인철도가 (철도창가)</title>
  <base href="./">
	<!-- Include font -->

	<!-- Include Amplitude JS -->
  <script type="text/javascript" src="./src/js/amplitude.js"></script>
	<!-- Include Style Sheet -->
	<!--  <link rel="stylesheet" type="text/css" href="./css/origin.css"/>-->
  <link rel="stylesheet" type="text/css" href="./css/fonts.css"/>
  <link rel="stylesheet" type="text/css" href="./css/style.css"/>
  <link rel="stylesheet" type="text/css" href="./css/playOnly.css"/>
</head>

<body>
<div id="container">
  <div id="header">
    <button>
      <img src="img/back-icon.svg">
      <span onclick="goBack()">뒤로가기</span>
    </button>
	  <!--<img src="img/ifac-logo.svg">-->
  </div>
  <div id="top-container">

    <div id="train-info">
      <div id="train-name">용산역</div>
      <div id="train-description">1955년 모습</div>
    </div>

    <div id="train-line">
      <div id="train-img">
        <img src="img/train_single.svg">
      </div>
      <div id="station-wrapper">
        <div class="station"><h1>서울역</h1></div>
        <div class="station"><h1>용산역</h1></div>
        <div class="station"><h1>노량진역</h1></div>
        <div class="station"><h1>영등포역</h1></div>
        <div class="station"><h1>오류동역</h1></div>
        <div class="station"><h1>부천역</h1></div>
        <div class="station"><h1>부평역</h1></div>
        <div class="station"><h1>주안역</h1></div>
        <div class="station"><h1>동인천역</h1></div>
        <div class="station"><h1>인천역</h1></div>
      </div>
    </div>

    <div id="cover">
      <img src="img/play-background-default.jpg" width="100%">
    </div>
  </div>

  <div id="bottom">
    <div id="controller">
      <div id="play-button-container">
        <button id="play-button" class="amplitude-play-pause">
          <!--<span>재생하기</span>-->
        </button>
      </div>
      <div id="player-progress-bar-container">
        <progress id="song-played-progress" class="amplitude-song-played-progress"></progress>
        <progress id="song-buffered-progress" class="amplitude-buffered-progress" value="0"></progress>
      </div>
      <div id="volume-container">
        <img src="./img/volume.svg"/>
        <input type="range" class="amplitude-volume-slider vertical-slider" step=".1" min="0" max="100" value="50"/>
      </div>
    </div>

	  <!--테스트 버튼-->
	  <!-- <div class="현재 모습"> -->
	  <!--   <div class="lyric-line" data-time="144">23</div> -->
	  <!--   <div class="lyric-line" data-time="154">24</div> -->
	  <!-- </div> -->
	  <!-- <div><span style="margin: 0 auto; text-align: center; width: 100%; display: block;" class="amplitude-duration-time"></span></div> -->

	  <!--가사 및 싱크 영역-->

    <div id="lyrics-mask-container">
	    <div id="lyrics-container">
		    <div class="lyric-line" data-order="1" data-time="4">한양을 작별하는 기적소리는</div>
        <div class="lyric-line" data-order="2" data-time="8">연화봉을 진동하며 작별을 하고</div>
        <div class="lyric-line" data-order="3" data-time="12">한 바퀴 두 바퀴는 차례로 굴러</div>
        <div class="lyric-line" data-order="4" data-time="16">종남산의 취색은 등에 멀었네</div>
		    <br/><br/>
        <div class="lyric-line" data-order="5" data-time="21">변화한 좌우 시가 다투어 비키고</div>
        <div class="lyric-line" data-order="6" data-time="25">굉-굉한 바퀴 소리는 땅을 가르는데</div>
        <div class="lyric-line" data-order="7" data-time="29">천지를 울리는 기적 일성은</div>
        <div class="lyric-line" data-order="8" data-time="33">장려한 용산역을 부수는 구나</div>
		    <br/><br/>
        <div class="lyric-line" data-order="9" data-time="42">경원선과 경부선을 서로 나누어</div>
        <div class="lyric-line" data-order="10" data-time="46">한 마디 기적으로 고별을 하고</div>
        <div class="lyric-line" data-order="11" data-time="50">웅장한 남한강의 철교를 지나</div>
        <div class="lyric-line" data-order="12" data-time="54">철도 요람 노량진역에 다다랐도다</div>
		    <br/><br/>
        <div class="lyric-line" data-order="13" data-time="58">살같이 나타나는 장엄한 기차</div>
        <div class="lyric-line" data-order="14" data-time="63">어언듯 영등포 잠깐 거치어</div>
        <div class="lyric-line" data-order="15" data-time="67">부산행 급행을 멀리 보내고</div>
        <div class="lyric-line" data-order="16" data-time="71">오류동 정거장 지내였고나</div>
		    <br/><br/>
        <div class="lyric-line" data-order="17" data-time="79">넓고 넓은 소사벌을 갈라나가면</div>
        <div class="lyric-line" data-order="18" data-time="83">소사역과 부평역도 차례로 거쳐</div>
        <div class="lyric-line" data-order="19" data-time="87">산 넘고 물 건너 급히 다다르니</div>
        <div class="lyric-line" data-order="20" data-time="92">빠르다 주안역도 지내였고나</div>
		    <br/><br/>
        <div class="lyric-line" data-order="21" data-time="96">먼산을 굽으려 가깝게하고</div>
        <div class="lyric-line" data-order="22" data-time="100">가까운 산을 뻗치어 멀게 하면서</div>
        <div class="lyric-line" data-order="23" data-time="104">살 같이 빨리 부는 나는 새 같이</div>
        <div class="lyric-line" data-order="24" data-time="108">어느덧 제물포에 다다랐도다</div>
      </div>
    </div>

  </div>
</div>
</body>

<!--
  Include UX functions JS

  NOTE: These are for handling things outside of the scope of AmplitudeJS
-->
<!--<script type="text/javascript" src="/src/js/kyongin.js"></script>-->
<script type="text/javascript" src="./src/js/function.js"></script>

<!-- AmplitudeJS 초기화 -->
<script>
  Amplitude.init({

	  "debug": true,
	  "autoplay": true,
	  "callbacks": {
		  "timeupdate": function () {
			  const currentTime = Amplitude.getSongPlayedSeconds();
			  highlightLyric(currentTime);

			  const stationIndex = getStationByTime(currentTime);
			  if (stationIndex !== -1) {
				  moveToStationSmoothly(stationIndex);
				  updateStationInfoByTime(currentTime);  // 추가된 함수 호출
			  }

		  },
	  },
	  "bindings": {
		  32: 'play_pause'
	  },
	  "songs": [
		  {
			  "name": "철도창가",
			  "artist": "",
			  "url": "./song/chuldo.mp3",
		  }
	  ],
  });

  /*시간별 구간으로 기차 이미지 이동 구현*/
  const timeIntervals = [
	  {start: 0, end: 28, station: 0, name: '서울역'},
	  {start: 29, end: 49, station: 1, name: '용산역'},
	  {start: 50, end: 57, station: 2, name: '노량진역'},
	  {start: 58, end: 66, station: 3, name: '영등포역'},
	  {start: 67, end: 78, station: 4, name: '오류동역'},
	  {start: 79, end: 83, station: 5, name: '부천역'},
	  {start: 84, end: 89, station: 6, name: '부평역'},
	  {start: 90, end: 95, station: 7, name: '주안역'},
	  {start: 96, end: 102, station: 8, name: '동인천역'},
	  {start: 103, end: 119, station: 9, name: '인천역'},
  ];

  /*Move To Station Function*/
  function getStationByTime(currentTime) {
	  for (let interval of timeIntervals) {
		  if (currentTime >= interval.start && currentTime < interval.end) {
			  return interval.station;
		  }
	  }
	  return -1; // 해당하는 구간이 없을 경우
  }

  let lastStationIndex = -1;

  function moveToStationSmoothly(index) {
	  if (index !== lastStationIndex) {
		  lastStationIndex = index;
		  moveToStation(index);
	  } else if (index !== -1) { // 해당하는 구간이 있을 경우
		  const interval = timeIntervals[index];
		  const progress = (Amplitude.getSongPlayedSeconds() - interval.start) / (interval.end - interval.start);
		  updateTrainPosition(index, progress);
	  }
  }

  function updateTrainPosition(index, progress) {
	  const currentStation = stations[index].getBoundingClientRect().left;
	  const nextStation = stations[index + 1] ? stations[index + 1].getBoundingClientRect().left : currentStation;
	  const trainPosition = currentStation + (nextStation - currentStation) * progress;

	  const trainImg = document.getElementById('train-img');
	  trainImg.style.left = trainPosition - 120 + 'px';
  }

  let currentStationIndex = 0;
  const stations = document.querySelectorAll('.station');
  let lastUpdateTime = 0; // 마지막으로 업데이트된 시간
  let targetStationIndex = 0; // 목표로 하는 역의 인덱스

  // 지하철역 활성화 애니메이션
  function moveToStation(index) {
	  // 모든 역의 active 클래스와 pulse-animation 클래스를 초기화
	  stations.forEach(station => {
		  station.classList.remove('active', 'pulse-animation');
	  });

	  // 이전 역의 previous 클래스를 초기화
	  if (currentStationIndex > 0) {
		  stations[currentStationIndex - 1].classList.remove('previous');
	  }

	  currentStationIndex = index;

	  // 현재 역에 active 클래스 추가
	  stations[currentStationIndex].classList.add('active');

	  // train-img의 위치를 현재 활성화된 역의 위치로 변경
	  const trainImg = document.getElementById('train-img');
	  const stationPosition = stations[currentStationIndex].getBoundingClientRect().left;
	  trainImg.style.left = stationPosition - 120 + 'px';

	  // 다음 역이 활성화 되기 3초 전에 pulse-animation 클래스 추가
	  const interval = getIntervalByTime(Amplitude.getSongPlayedSeconds());
	  if (interval && (interval.end - Amplitude.getSongPlayedSeconds()) <= 3) {
		  stations[currentStationIndex + 1].classList.add('pulse-animation');
	  }
  }

  /*Change Info Function*/
  const stationDetails = [
	  {
		  station: 0,
		  titles: ['경성역', '서울역'],
		  description: ['1929년 모습', '현재 모습'],
		  images: ['./img/station-thumb/1-1.png', './img/station-thumb/1-c-3.png']
	  },
	  {
		  station: 1,
		  titles: ['용산역'],
		  description: ['1915년 모습', '현재 모습'],
		  images: ['./img/station-thumb/2-1.png', './img/station-thumb/2-c-3.png']
	  },
	  {
		  station: 2,
		  titles: ['노량진역'],
		  description: ['과거 모습', '현재 모습'],
		  images: ['./img/station-thumb/r-4.png', './img/station-thumb/3-c-3.png']
	  },
	  {
		  station: 3,
		  titles: ['영등포역'],
		  description: ['과거 모습', '현재 모습'],
		  images: ['./img/station-thumb/r-5.png', './img/station-thumb/4-c-3.png']
	  },
	  {
		  station: 4,
		  titles: ['오류동역'],
		  description: ['과거 모습', '현재 모습'],
		  images: ['./img/station-thumb/r-6.png', './img/station-thumb/5-c-2.png']
	  },
	  {
		  station: 5,
		  titles: ['부천역', '소사역'],
		  description: ['과거 모습', '현재 모습'],
		  images: ['./img/station-thumb/r-7.png', './img/station-thumb/6-c-3.png']
	  },
	  {
		  station: 6,
		  titles: ['부평역'],
		  description: ['과거 모습', '현재 모습'],
		  images: ['./img/station-thumb/r-8.png', './img/station-thumb/7-c-2.png']
	  },
	  {
		  station: 7,
		  titles: ['주안역'],
		  description: ['과거 모습', '현재 모습'],
		  images: ['./img/station-thumb/r-9.png', './img/station-thumb/8-c-2.png']
	  },
	  {
		  station: 8,
		  titles: ['동인천역', '축현역'],
		  description: ['과거 모습', '현재 모습'],
		  images: ['./img/station-thumb/9-1.png', './img/station-thumb/9-c-2.png']
	  },
	  {
		  station: 9,
		  titles: ['인천역', '제물포역'],
		  description: ['과거 모습', '현재 모습'],
		  images: ['./img/station-thumb/10-3.png', './img/station-thumb/10-c-3.png']
	  }




	  // ... 나머지 역에 대한 정보도 동일하게 추가 ...
  ];

  function getIntervalByTime(currentTime) {
	  for (let interval of timeIntervals) {
		  if (currentTime >= interval.start && currentTime < interval.end) {
			  return interval;
		  }
	  }
	  return null; // 해당하는 구간이 없을 경우
  }

  let currentTitle = "";
  let currentDescription = "";
  let currentImage = "";


  /*시간 및 구간에 따라 타이틀 및 배경 이미지 변경*/
  function updateStationInfoByTime(currentTime) {
	  const interval = getIntervalByTime(currentTime);
	  if (interval) {
		  const details = stationDetails.find(detail => detail.station === interval.station);
		  if (details) {
			  const titleIndex = Math.floor((currentTime - interval.start) / (interval.end - interval.start) * details.titles.length);
			  const descriptionIndex = Math.floor((currentTime - interval.start) / (interval.end - interval.start) * details.images.length);
			  const imageIndex = Math.floor((currentTime - interval.start) / (interval.end - interval.start) * details.images.length);

			  const newTitle = details.titles[titleIndex];
			  const newDescription = details.description[descriptionIndex];
			  const newImage = details.images[imageIndex];

			  // Check if content has changed
			  if (newTitle !== currentTitle || newDescription !== currentDescription || newImage !== currentImage) {
				  const trainNameElement = document.getElementById('train-name');
				  const trainDescriptionElement = document.getElementById('train-description');
				  const coverElement = document.querySelector('#cover img');

				  // Fade out effect
				  trainNameElement.classList.add('fade-out');
				  trainDescriptionElement.classList.add('fade-out');
				  coverElement.classList.add('fade-out');

				  // 이미지 교체를 fade-out 애니메이션 중간에 진행
				  setTimeout(() => {
					  trainNameElement.innerHTML = newTitle;
					  trainDescriptionElement.textContent = newDescription;
					  coverElement.src = newImage;

					  // Fade in effect 추가
					  trainNameElement.classList.add('fade-in');
					  trainDescriptionElement.classList.add('fade-in');
					  coverElement.classList.add('fade-in');

					  // Fade out class 제거
					  trainNameElement.classList.remove('fade-out');
					  trainDescriptionElement.classList.remove('fade-out');
					  coverElement.classList.remove('fade-out');
				  }, 400); // fade-out 애니메이션의 절반 시간에 이미지 교체

				  // Update the currentTitle and currentImage
				  currentTitle = newTitle;
				  currentDescription = newDescription;
				  currentImage = newImage;
			  }
		  }
	  }
  }
</script>
</html>
